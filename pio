using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Windows.Media.Media3D;

public static class PointCloudIO
{
    private static readonly CultureInfo Invariant = CultureInfo.InvariantCulture;

    /// <summary>
    /// Save a point cloud as simple text .xyz file: "x y z" per line.
    /// Optional header lines start with '#'.
    /// </summary>
    public static void SaveAsXyz(
        string filePath,
        Point3DCollection points,
        IEnumerable<string>? headerLines = null)
    {
        if (points == null)
            throw new ArgumentNullException(nameof(points));

        using var writer = new StreamWriter(filePath);

        // Optional metadata header
        if (headerLines != null)
        {
            foreach (var line in headerLines)
                writer.WriteLine("# " + line);
        }

        foreach (var p in points)
        {
            writer.WriteLine(
                string.Format(Invariant, "{0} {1} {2}", p.X, p.Y, p.Z));
        }
    }

    /// <summary>
    /// Load a point cloud from a .xyz-like text file: "x y z" per line.
    /// Lines starting with '#' are ignored.
    /// </summary>
    public static Point3DCollection LoadFromXyz(string filePath)
    {
        var result = new Point3DCollection();

        foreach (var line in File.ReadLines(filePath))
        {
            var trimmed = line.Trim();

            // Skip comments / empty lines
            if (string.IsNullOrEmpty(trimmed) || trimmed.StartsWith("#"))
                continue;

            var parts = trimmed.Split((char[])null!, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length < 3)
                continue; // or throw if you want strict parsing

            if (double.TryParse(parts[0], NumberStyles.Float, Invariant, out double x) &&
                double.TryParse(parts[1], NumberStyles.Float, Invariant, out double y) &&
                double.TryParse(parts[2], NumberStyles.Float, Invariant, out double z))
            {
                result.Add(new Point3D(x, y, z));
            }
            else
            {
                // Optionally log or throw here
            }
        }

        return result;
    }

    /// <summary>
    /// Save a point cloud in a compact binary format:
    /// [int32 count][double x][double y][double z]...
    /// </summary>
    public static void SaveAsBinary(string filePath, Point3DCollection points)
    {
        if (points == null)
            throw new ArgumentNullException(nameof(points));

        using var fs = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None);
        using var bw = new BinaryWriter(fs);

        bw.Write(points.Count);
        foreach (var p in points)
        {
            bw.Write(p.X);
            bw.Write(p.Y);
            bw.Write(p.Z);
        }
    }

    /// <summary>
    /// Load a point cloud from the binary format defined in SaveAsBinary.
    /// </summary>
    public static Point3DCollection LoadFromBinary(string filePath)
    {
        using var fs = new FileStream(filePath, FileMode.Open, FileAccess.Read, FileShare.Read);
        using var br = new BinaryReader(fs);

        int count = br.ReadInt32();
        var result = new Point3DCollection(count);

        for (int i = 0; i < count; i++)
        {
            double x = br.ReadDouble();
            double y = br.ReadDouble();
            double z = br.ReadDouble();
            result.Add(new Point3D(x, y, z));
        }

        return result;
    }
}